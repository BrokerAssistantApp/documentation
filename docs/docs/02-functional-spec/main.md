---
sidebar_position: 1
---

# Взаимодействие системы

> Могут быть несоответствия, раздел не обновлен

## 1. Пользователи

### 1.1 Регистрация брокера

- В системе могут регистрироваться только брокеры.
- Регистрация осуществляется через форму с полями:
    - `email` — уникальный адрес электронной почты;
    - `name` — имя пользователя;
    - `password` — пароль (при выборе входа по email/паролю);
    - или авторизация через Яндекс ID.
- После успешной регистрации создается пользователь с флагом `is_broker = true`.
- Брокер получает доступ к личному кабинету, где может:
    - добавлять инвесторов и партнёров (участников);
    - создавать и редактировать лоты;
    - просматривать статистику и отчёты.
- У одного email может быть только один брокер.
- Авторизация брокера осуществляется через:
    - форму входа с email и паролем;
    - или Яндекс ID, если была связка при регистрации.

### 1.2 Создание участников

- Брокер может создавать участников вручную: инвесторов и/или партнёров.
- При создании участника указывается:
    - `name` — имя пользователя;
    - `email` — уникальный email, используется для входа;
    - `auth_method` — метод авторизации (`password` или `yandex`);
- Если выбран метод `password`:
    - Генерируется случайный пароль;
    - Участнику предоставляется возможность сменить его после первого входа.
- Если выбран метод `yandex`:
    - Участник сможет войти через Яндекс ID, без пароля.
- После создания участник автоматически привязывается к брокеру через таблицу `broker_members`.
- Один и тот же участник может быть:
    - Привязан к нескольким брокерам (многие-ко-многим);
    - Участвовать в нескольких лотах одновременно;
    - Быть как инвестором, так и партнёром.
- Доступ участника ограничен:
    - Он может видеть только те лоты, в которых участвует;
    - Он не может редактировать лота, состав участников, статусы лотов и финансы других.

### 1.3 Авторизация

- Пользователи входят в систему двумя способами:
    - по email и паролю;
    - через Яндекс ID (OAuth).
- После входа создается сессия (`refreshToken` хранится в cookie и базе данных).
- Доступ к защищённым эндпоинтам требует авторизации по `accessToken` (httpOnly-cookie).
- Поддерживается множественная авторизация (несколько сессий одновременно).

---

## 2. Управление лотами

### 2.1 Создание, редактирование и удаление лота

- Брокер может создавать лот с указанием следующих данных:
    - `name` - название лота
    - `trade_number` — номер торгов
    - `etp_url` — ссылка на площадку ЭТП
    - `purchase_date` - дата покупки
    - `status` - статус лота
    - `purchase_price` - стоимость покупки
    - `sale_price` - ожидаемая цена продажи
    - `broker_commission_percent` - процент комиссии брокера
    - `broker_tax_percent` - процент налога брокера
- После создания лота:
    - Ему автоматически присваивается статус `purchased`
    - В таблицу `lot_status_history` добавляется запись о статусе `purchased`
    - Для всех участников с заполненным `investment_amount` создаются транзакции типа `investment` с соответствующей
      суммой
- Брокер может редактировать данные лота до смены его статуса на `sold`
    - Можно изменять: название, номер, ссылку на ЭТП, дату покупки, сумму покупки, проценты комиссии и налога
- Лот может быть удалён брокером при соблюдении условий:
    - Если в лоте нет ни одного участника — выполняется жесткое удаление из базы данных.
    - Если в лоте есть участники, но статус еще не достиг `sold` или не находится в `closed` — выполняется мягкое
      удаление (лот помечается как удалённый).
    - Если лот имеет статус `sold` или `closed` — удаление невозможно.
- Мягко удалённый лот исключается из всех списков, но остаётся в БД для аудита и исторических данных.

### 2.2 Участники лота

- Участником лота может быть любой пользователь, включая самого брокера, создавшего лот.
- К лоту можно привязать участников через `member_id`:
    - Если участник является инвестором:
        - Указывается сумма инвестиций (`investment_amount`)
        - Указывается доля прибыли (`share_percent`)
    - Если участник является партнёром:
        - Указывается процент комиссии за привлечение (`referral_fee_percent`)
        - В поле `referral_member_id` указывается `member_id` инвестора, которого он привёл
    - Если участник является и инвестором, и партнёром, заполняются все соответствующие поля.

### 2.3 Управление статусами

- Статусы лота изменяются только через отдельный эндпоинт `/lots/{lotId}/status`.
- История всех изменений сохраняется в `lot_status_history`.
- После смены статуса на `sold`:
    - Создаются транзакции:
        - `payout` — выплаты инвесторам в соответствии с их долей
        - `broker_commission` — комиссия брокеру
        - `broker_tax` — налог брокера
        - `referral_fee` — вознаграждение партнёрам
    - Рассчитываются финансовые итоги (`lot_financials`).
- После смены на `sold` или `closed` — все изменения в лоте невозможны.
- Откат возможен только между статусами `renovation`, `hold`, `listed_for_sale`.

---

## 3. Расходы и транзакции

### 3.1 Расходы

- Брокер может добавлять траты, связанные с лотом:
    - Описание траты
    - Каждая трата связана с транзакцией `lot_transactions` типа `expense`
- Добавление, редактирование и удаление расходов возможно только до статуса `sold`.

### 3.2 Транзакции

- Все транзакции хранятся в `lot_transactions`:
    - `investment` — инвестиции инвесторов
    - `payout` — выплаты инвесторам
    - `referral_fee` — выплаты партнерам
    - `broker_commission` — комиссия брокера
    - `broker_tax` — налоги брокера
    - `expense` — расходы по лоту
- Каждая транзакция содержит:
    - Сумму (`amount`)
    - Дату создания (`created_at`)
    - Привязку к пользователю (`user_id`), если это применимо:
        - Указывается для типов: `investment`, `payout`, `referral_fee`, `broker_commission`, `broker_tax`
        - Не указывается (остается `NULL`) для типа `expense`

---

## 4. Финансовый учет

### 4.1 Финансовые итоги

- После смены статуса лота на `sold` создаётся запись в `lot_financials`.
- Для каждого проданного лота сохраняется следующая информация:
    - `sale_price` — финальная стоимость продажи лота, указанная брокером
    - `purchase_price` — цена покупки лота, указанная при создании
    - `gross_profit` — валовая прибыль: разница между ценой продажи и ценой покупки
    - `net_profit` — чистая прибыль: валовая прибыль за вычетом всех расходов, налогов и комиссий
    - `broker_commission` — комиссия брокера, рассчитывается по формуле: `sale_price` - `total_investments` -
      `broker_tax` - `total_expenses`
    - `broker_tax` — сумма налога брокера, рассчитывается от полной стоимости продажи: `sale_price` *
      `broker_tax_percent` / `100`
    - `total_expenses` — сумма всех расходов по лоту
    - `total_investments` — сумма всех инвестиций участников в лот
    - `total_payouts` — сумма выплат инвесторам
    - `total_referral_fees` — сумма реферальных выплат партнерам
    - `created_at` — дата фиксации итогов в системе
- Эти данные используются для формирования аналитических отчетов по лотам, а также отчетов для инвесторов и партнеров.

### 4.2 Отчёты

- Участники могут просматривать:
    - Свои вложения, долю прибыли, выплаты и комиссии
- Брокеры получают доступ к:
    - Статистике по лотам
    - Графикам инвестиций, прибыли и расходов

---

## 5. Доступ

### 5.1 Ограничения доступа

- Участники могут видеть только те лоты, в которых участвуют.
- Брокеры имеют доступ ко всем своим данным и участникам.